<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¶–µ–Ω –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-color: #f4f7f9;
        color: #333;
        margin: 0;
        padding: 20px;
      }
      #app {
        max-width: 1200px;
        margin: 0 auto;
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      h1,
      h2,
      h4 {
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
        margin-top: 20px;
      }
      .file-loader,
      .filters,
      .charts-container {
        margin-bottom: 25px;
      }
      .file-input {
        display: block;
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }
      .filter-section label {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 12px;
        background: #f0f0f0;
        border-radius: 15px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .filter-section label:hover {
        background-color: #e0e0e0;
      }
      .filter-section input[type='checkbox'] {
        accent-color: #42b983;
      }
      .chart-wrapper {
        margin-top: 30px;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .placeholder {
        text-align: center;
        padding: 50px;
        color: #777;
        border: 2px dashed #ccc;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>üìà –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¶–µ–Ω –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</h1>

      <div class="file-loader">
        <label for="fileInput">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à JSON —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</label>
        <input
          id="fileInput"
          class="file-input"
          type="file"
          @change="loadFile"
          accept=".json"
        />
      </div>

      <div class="filters" v-if="jsonData">
        <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
        <div class="filter-section">
          <label>
            <input
              type="checkbox"
              @change="toggleAll('components')"
              :checked="allComponentsSelected"
            />
            <strong>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</strong>
          </label>
          <label>
            <input
              type="checkbox"
              @change="toggleAll('stores')"
              :checked="allStoresSelected"
            />
            <strong>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã</strong>
          </label>
        </div>

        <h4>–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ:</h4>
        <div class="filter-section">
          <label v-for="component in availableComponents" :key="component">
            <input
              type="checkbox"
              v-model="selectedComponents"
              :value="component"
            />
            {{ component }}
          </label>
        </div>

        <h4>–ú–∞–≥–∞–∑–∏–Ω—ã:</h4>
        <div class="filter-section">
          <label v-for="store in availableStores" :key="store">
            <input type="checkbox" v-model="selectedStores" :value="store" />
            {{ store }}
          </label>
        </div>
      </div>

      <hr v-if="jsonData" />

      <div class="charts-container">
        <div v-if="!jsonData" class="placeholder">
          <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.</p>
        </div>
        <div v-else-if="filteredData.length === 0" class="placeholder">
          <p>
            –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –∏ –æ–¥–∏–Ω –º–∞–≥–∞–∑–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞.
          </p>
        </div>
        <div v-else>
          <div
            v-for="componentData in filteredData"
            :key="componentData.name"
            class="chart-wrapper"
          >
            <h4>{{ componentData.name }}</h4>
            <canvas
              :data-component-name="componentData.name"
              :ref="setChartRef"
            ></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, watch, nextTick, onBeforeUpdate } = Vue;

      createApp({
        setup() {
          // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ (State) ---
          const jsonData = ref(null);
          const availableComponents = ref([]);
          const availableStores = ref([]);
          const selectedComponents = ref([]);
          const selectedStores = ref([]);

          const chartRefs = ref({});
          let chartInstances = {};

          const chartColors = [
            '#42b983',
            '#3498db',
            '#e74c3c',
            '#9b59b6',
            '#f1c40f',
            '#1abc9c',
            '#e67e22',
            '#34495e',
            '#2980b9',
            '#c0392b',
          ];

          // --- –ú–µ—Ç–æ–¥—ã (Methods) ---
          const loadFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                jsonData.value = data;
                processData(data);
              } catch (error) {
                alert(
                  '–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–µ—Ä–Ω–∞.'
                );
                console.error('JSON Parse Error:', error);
              }
            };
            reader.readAsText(file);
          };

          const processData = (data) => {
            const components = Object.keys(data);
            const stores = new Set();

            components.forEach((component) => {
              data[component].forEach((dateEntry) => {
                const date = Object.keys(dateEntry)[0];
                dateEntry[date].forEach((storeEntry) => {
                  stores.add(Object.keys(storeEntry)[0]);
                });
              });
            });

            availableComponents.value = components;
            availableStores.value = Array.from(stores).sort();

            // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            selectedComponents.value = [...components];
            selectedStores.value = [...availableStores.value];
          };

          // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ canvas-—ç–ª–µ–º–µ–Ω—Ç—ã
          const setChartRef = (el) => {
            if (el) {
              chartRefs.value[el.dataset.componentName] = el;
            }
          };

          // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º DOM
          onBeforeUpdate(() => {
            chartRefs.value = {};
          });

          // --- –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ (Computed) ---
          const filteredData = computed(() => {
            if (
              !jsonData.value ||
              selectedComponents.value.length === 0 ||
              selectedStores.value.length === 0
            ) {
              return [];
            }

            return selectedComponents.value.map((componentName) => {
              const componentHistory = jsonData.value[componentName];
              const labels = [
                ...new Set(
                  componentHistory.map((entry) => Object.keys(entry)[0])
                ),
              ].sort(
                (a, b) =>
                  new Date(a.split('.').reverse().join('-')) -
                  new Date(b.split('.').reverse().join('-'))
              );

              const datasets = selectedStores.value.map((storeName, index) => {
                const data = labels.map((label) => {
                  const dateEntry = componentHistory.find(
                    (entry) => Object.keys(entry)[0] === label
                  );
                  if (dateEntry) {
                    const storeEntry = dateEntry[label].find(
                      (s) => Object.keys(s)[0] === storeName
                    );
                    return storeEntry ? storeEntry[storeName] : null;
                  }
                  return null;
                });

                return {
                  label: storeName,
                  data: data,
                  borderColor: chartColors[index % chartColors.length],
                  backgroundColor:
                    chartColors[index % chartColors.length] + '33', // c –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
                  fill: false,
                  tension: 0.1,
                  spanGaps: true, // –°–æ–µ–¥–∏–Ω—è–µ—Ç —Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ null –∑–Ω–∞—á–µ–Ω–∏—è
                };
              });

              return { name: componentName, labels, datasets };
            });
          });

          const allComponentsSelected = computed(
            () =>
              availableComponents.value.length > 0 &&
              selectedComponents.value.length ===
                availableComponents.value.length
          );
          const allStoresSelected = computed(
            () =>
              availableStores.value.length > 0 &&
              selectedStores.value.length === availableStores.value.length
          );

          const toggleAll = (type) => {
            if (type === 'components') {
              if (allComponentsSelected.value) {
                selectedComponents.value = [];
              } else {
                selectedComponents.value = [...availableComponents.value];
              }
            } else if (type === 'stores') {
              if (allStoresSelected.value) {
                selectedStores.value = [];
              } else {
                selectedStores.value = [...availableStores.value];
              }
            }
          };

          // --- –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ (Watchers) ---
          watch(
            filteredData,
            (newData) => {
              nextTick(() => {
                const newComponentNames = new Set(newData.map((d) => d.name));

                // –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã
                for (const name in chartInstances) {
                  if (!newComponentNames.has(name)) {
                    chartInstances[name].destroy();
                    delete chartInstances[name];
                  }
                }

                newData.forEach((componentData) => {
                  const canvas = chartRefs.value[componentData.name];
                  if (!canvas) return;

                  const ctx = canvas.getContext('2d');

                  if (chartInstances[componentData.name]) {
                    // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥—Ä–∞—Ñ–∏–∫
                    const chart = chartInstances[componentData.name];
                    chart.data.labels = componentData.labels;
                    chart.data.datasets = componentData.datasets;
                    chart.update();
                  } else {
                    // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
                    chartInstances[componentData.name] = new Chart(ctx, {
                      type: 'line',
                      data: {
                        labels: componentData.labels,
                        datasets: componentData.datasets,
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                          y: {
                            beginAtZero: false,
                            ticks: {
                              callback: function (value, index, ticks) {
                                return value + ' –≥—Ä–Ω';
                              },
                            },
                          },
                        },
                        plugins: {
                          tooltip: {
                            mode: 'index',
                            intersect: false,
                          },
                          legend: {
                            position: 'top',
                          },
                        },
                        interaction: {
                          mode: 'index',
                          intersect: false,
                        },
                      },
                    });
                  }
                });
              });
            },
            { deep: true }
          );

          return {
            jsonData,
            loadFile,
            availableComponents,
            availableStores,
            selectedComponents,
            selectedStores,
            filteredData,
            setChartRef,
            toggleAll,
            allComponentsSelected,
            allStoresSelected,
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
